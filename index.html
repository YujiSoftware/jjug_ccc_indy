<!DOCTYPE html>
<html>
  <head>
    <title>Title</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <style type="text/css">
    @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
    @import url(https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
    @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

    body { font-family: 'Droid Serif'; }
    h1, h2, h3 {
    font-family: 'Yanone Kaffeesatz';
    font-weight: normal;
    }
    .remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; }
    
    .move {
        animation: anim 0.5s ease-out;
    }
    @keyframes anim {
        0% {
            transform: translateX(300px);
        }
        100% {
            transform: translateX(0px);
        }
    }
    </style>
  </head>
  <body>
    <textarea id="source">

class: center, middle

# InvokeDynamic, Under the Hood

<!-- Agenda はあえて出さない -->

---
class: center, middle

# javap <span style="font-size: 16pt;">してますか?</span>

---

# javap

- クラスファイル解析ツール
 - クラスやメソッドの情報抽出
 - バイトコード解析

---

たとえば...

```Java
public class Foo {
  public static void main(String... args) {
    System.out.println("ABC" + "DEF");
  }
}
```

コンパイルして、javapしてみると...

--

```
> javac Foo.java

> javap Foo
Compiled from "Foo.java"
public class Foo {
  public Foo();
  public static void main(java.lang.String...);
}
```

--

- ソースに記述はないが、デフォルトコンストラクタが定義
- 変数名、メソッド引数名はなくなってしまう

---

```
> javap -c Foo
Compiled from "Foo.java"
public class Foo {
  public Foo();
    Code:
       0: aload_0
       1: invokespecial #1   // Method java/lang/Object."<init>":()V
       4: return

  public static void main(java.lang.String...);
    Code:
       0: getstatic     #7  // Field java/lang/System.out:Ljava/io/PrintStream;
       3: ldc           #13 // String ABCDEF
       5: invokevirtual #15 // Method java/io/PrintStream.println:(Ljava/lang/String;)V
       8: return
}
```

<div style="text-align: right;">-c: バイトコードに逆アセンブル</div>
	
--

- リテラル文字列の加算はコンパイル時に行われる
- invokeで始まるバイトコードがメソッドコール


---

では、これでは

```Java
public class Foo {
  public static void main(String... args) {
    var x = "ABC";
    var y = "DEF";
    System.out.println(x + y);
  }
}
```

---

```console
> javap -c Foo
Compiled from "Foo.java"
public class Foo {
  <<省略>>

  public static void main(java.lang.String...);
    Code:
       0: ldc           #7                  // String ABC
       2: astore_1
       3: ldc           #7                  // String DEF
       5: astore_2
       6: getstatic     #9                  // Field java/lang/System.out:Ljava/io/PrintStream;
       9: aload_1
      10: aload_2
      11: invokedynamic #15,  0             // InvokeDynamic #0:makeConcatWithConstants:(Ljava/lang/String;Ljava/lang/String;)Ljava/lang/String;
      16: invokevirtual #19                 // Method java/io/PrintStream.println:(Ljava/lang/String;)V
      19: return
}
```

--

- メソッドコールをしていないのにinvokeで始まるバイトコードが

--
  
<h2 style="text-align: center;">このinvokeDynamicが今日の主役</h2>

---

# Transform

Java のどこで InvokeDynamic が使われている？（Java22時点）

--

.move[
* Lambda
* String concat （+ 演算子による文字列結合）
* Pattern Matching for switch
* Recod class
  * toString, hashCode, equals メソッドの実装）
]

    </textarea>
    <script src="https://remarkjs.com/downloads/remark-latest.min.js" type="text/javascript">
    </script>
    <script type="text/javascript">
      var slideshow = remark.create();
    </script>
  </body>
</html>
